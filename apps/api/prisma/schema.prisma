generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  OTHER
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  OTHER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum IdempotencyStatus {
  PROCESSING
  COMPLETED
}

model User {
  id          String    @id @default(cuid())
  firebaseUid String    @unique
  email       String    @unique
  role        Role      @default(USER)
  accounts    Account[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Account {
  id           String        @id @default(cuid())
  userId       String
  type         AccountType   @default(CHECKING)
  name         String
  balanceCents Int           @default(0)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]

  @@unique([userId, name])
  @@index([userId, type])
  @@index([userId])
}

model Transaction {
  id              String            @id @default(cuid())
  accountId       String
  amountCents     Int
  transferId      String            @default(cuid())
  transactionDate DateTime          @default(now())
  transactionNote String?           @default("") @db.VarChar(255)
  status          TransactionStatus @default(PENDING)
  errorMessage    String?
  type            TransactionType   @default(OTHER)
  account         Account           @relation(fields: [accountId], references: [id], onDelete: Restrict)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([accountId])
  @@index([transferId])
  @@index([accountId, transactionDate])
  @@index([accountId, id])
}

model IdempotencyRecord {
  id              String            @id @default(cuid())
  userId          String
  idempotencyKey  String
  status          IdempotencyStatus
  responsePayload Json?
  createdAt       DateTime          @default(now())

  @@unique([userId, idempotencyKey])
  @@index([userId, idempotencyKey])
}
